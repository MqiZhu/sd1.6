# coding: utf-8
import threading
from modules.task.zyclients import DrawClient
import time
from modules.task.log import get_logger
from modules.task.handler import handle_task


def fetch_and_dispatch():
    client = DrawClient()
    logger = get_logger()

    while True:
        suc, data = client.fetch()
        if not suc:
            logger.info("get task failed:{data}")
            time.sleep(5)
            continue

        has_task = data.get("has_task", False)
        wait = data.get("wait", 1)
        if not has_task:
            time.sleep(wait)
            logger.info("No Task Wait!ing!")
            continue

        task = data.get("task")
        task_id = task.get("task_id")
        params = task["real_param"]
        task_type = task["task_type"]

        handle_task(task_type, params)


def run():
    t = threading.Thread(target=fetch_and_dispatch, args=(q,))
    t.daemon = True
    t.start()
    return t


if __name__ == "__main__":

    t = run
    t.jion()
